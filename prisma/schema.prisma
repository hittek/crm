generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Organization model - multi-tenancy support
model Organization {
  id          Int       @id @default(autoincrement())
  name        String
  slug        String    @unique // URL-friendly identifier
  logo        String?
  favicon     String?
  primaryColor String?  @default("#2563eb")
  currency    String    @default("MXN")
  timezone    String    @default("America/Mexico_City")
  locale      String    @default("es-MX")
  isActive    Boolean   @default(true)
  orgSettings String?   // JSON for org-specific settings
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  users         User[]
  contacts      Contact[]
  deals         Deal[]
  tasks         Task[]
  activities    Activity[]
  savedViews    SavedView[]
  auditLogs     AuditLog[]
  notifications Notification[]
}

// Contact model - the core entity in a contacts-first CRM
model Contact {
  id          Int       @id @default(autoincrement())
  firstName   String
  lastName    String
  email       String?
  phone       String?
  mobile      String?
  company     String?
  role        String?
  address     String?
  city        String?
  state       String?
  country     String?
  postalCode  String?
  website     String?
  linkedin    String?
  twitter     String?
  source      String?   // referral, website, cold-call, etc.
  status      String    @default("active") // active, inactive, lead, prospect
  tags        String?   // comma-separated tags
  notes       String?
  avatar      String?
  isPrivate   Boolean   @default(false)
  visibility  String    @default("org") // org = visible to all, private = only owner/assigned users
  visibleTo   String?   // JSON array of user IDs when visibility is 'private'
  ownerId     Int?      // Owner user
  owner       User?     @relation("ContactOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  organizationId Int    // Organization this contact belongs to
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?
  updatedBy   String?

  // Relations
  deals       Deal[]
  tasks       Task[]
  activities  Activity[]

  @@unique([email, organizationId]) // Email unique per organization
  @@index([organizationId])
}

// Deal/Opportunity model - for the pipeline view
model Deal {
  id              Int       @id @default(autoincrement())
  title           String
  value           Float     @default(0)
  currency        String    @default("MXN")
  stage           String    @default("lead") // lead, qualified, proposal, negotiation, won, lost
  probability     Int       @default(10) // 0-100
  expectedClose   DateTime?
  actualClose     DateTime?
  description     String?
  lostReason      String?
  owner           String?
  priority        String    @default("medium") // low, medium, high
  tags            String?
  visibility      String    @default("org") // org = visible to all, private = only owner/assigned users
  visibleTo       String?   // JSON array of user IDs when visibility is 'private'
  ownerId         Int?      // Owner user
  ownerUser       User?     @relation("DealOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  organizationId  Int       // Organization this deal belongs to
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdBy       String?
  updatedBy       String?

  // Relations
  contactId       Int?
  contact         Contact?  @relation(fields: [contactId], references: [id], onDelete: SetNull)
  tasks           Task[]
  activities      Activity[]

  @@index([organizationId])
}

// Task model - for task management
model Task {
  id            Int       @id @default(autoincrement())
  title         String
  description   String?
  status        String    @default("pending") // pending, in-progress, completed, cancelled
  priority      String    @default("medium") // low, medium, high
  dueDate       DateTime?
  dueTime       String?   // HH:mm format
  reminderDate  DateTime?
  completedAt   DateTime?
  type          String    @default("task") // task, call, email, meeting
  isRecurring   Boolean   @default(false)
  recurringRule String?   // iCal RRULE format
  owner         String?
  visibility    String    @default("org") // org = visible to all, assignee = only assigned user
  assignedToId  Int?      // User responsible for the task
  assignedTo    User?     @relation("TaskAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  ownerId       Int?      // Owner/creator user
  ownerUser     User?     @relation("TaskOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  organizationId Int      // Organization this task belongs to
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdBy     String?
  updatedBy     String?

  // Relations
  contactId     Int?
  contact       Contact?  @relation(fields: [contactId], references: [id], onDelete: SetNull)
  dealId        Int?
  deal          Deal?     @relation(fields: [dealId], references: [id], onDelete: SetNull)

  @@index([organizationId])
}

// Activity model - timeline of interactions
model Activity {
  id            Int       @id @default(autoincrement())
  type          String    // email, call, meeting, note, task_completed, deal_updated, etc.
  subject       String
  content       String?
  outcome       String?   // for calls: answered, voicemail, no-answer
  duration      Int?      // in minutes
  isPrivate     Boolean   @default(false)
  metadata      String?   // JSON for extra data
  organizationId Int      // Organization this activity belongs to
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  createdBy     String?

  // Relations
  contactId     Int?
  contact       Contact?  @relation(fields: [contactId], references: [id], onDelete: SetNull)
  dealId        Int?
  deal          Deal?     @relation(fields: [dealId], references: [id], onDelete: SetNull)

  @@index([organizationId])
}

// User model - for authentication and ownership
model User {
  id          Int       @id @default(autoincrement())
  email       String
  password    String?   // Hashed password (nullable for migration, required for new users)
  name        String
  avatar      String?
  role        String    @default("user") // admin, manager, user
  timezone    String    @default("America/Mexico_City")
  locale      String    @default("es-MX")
  isActive    Boolean   @default(true)
  preferences String?   // JSON for user preferences
  lastLoginAt DateTime? // Track last login time
  organizationId Int    // Organization this user belongs to
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  assignedTasks   Task[]          @relation("TaskAssignee")
  ownedTasks      Task[]          @relation("TaskOwner")
  ownedContacts   Contact[]       @relation("ContactOwner")
  ownedDeals      Deal[]          @relation("DealOwner")
  auditLogs       AuditLog[]
  notifications   Notification[]

  @@unique([email, organizationId]) // Email unique per organization
  @@index([organizationId])
}

// SavedView model - for saved filters/views
model SavedView {
  id          Int       @id @default(autoincrement())
  name        String
  entity      String    // contacts, deals, tasks
  filters     String    // JSON filters
  columns     String?   // JSON column configuration
  sortBy      String?
  sortOrder   String    @default("asc")
  isDefault   Boolean   @default(false)
  isShared    Boolean   @default(false)
  organizationId Int    // Organization this view belongs to
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([organizationId])
}

// AuditLog model - tracks all user actions for activity timeline
model AuditLog {
  id          Int       @id @default(autoincrement())
  action      String    // created, updated, deleted, completed, stage_changed, assigned, etc.
  entity      String    // contact, deal, task, user, settings
  entityId    Int?      // ID of the affected entity
  entityName  String?   // Human-readable name (e.g., "Llamar a Juan")
  details     String?   // JSON with additional details (old/new values, etc.)
  userId      Int?      // User who performed the action
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  userName    String?   // Cached user name for display
  organizationId Int?   // Organization context
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime  @default(now())

  @@index([entity, entityId])
  @@index([userId])
  @@index([organizationId])
  @@index([createdAt])
}

// Notification model - in-app notifications
model Notification {
  id            Int       @id @default(autoincrement())
  type          String    // task_reminder, new_contact, deal_won, deal_lost, task_assigned, mention, etc.
  title         String
  message       String?
  link          String?   // URL to navigate when clicked (e.g., /tasks?id=123)
  isRead        Boolean   @default(false)
  readAt        DateTime?
  metadata      String?   // JSON for extra data (entityType, entityId, etc.)
  userId        Int       // User to notify
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId Int      // Organization context
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt     DateTime  @default(now())

  @@index([userId, isRead])
  @@index([organizationId])
  @@index([createdAt])
}
